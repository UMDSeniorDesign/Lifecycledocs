<html>
	<head>
		<HTA:APPLICATION
		border="thin"
		borderStyle="normal"
		caption="yes"
		maximizeButton="yes"
		minimizeButton="yes"
		showInTaskbar="no"
		windowState="maximize"
		innerBorder="yes"
		navigable="yes"
		scroll="auto"
		scrollFlat="yes" />
	    <style type="text/css">
		    #xsltDiv {
		    
			}
	    </style>
		
		<script src="../JS/loadXML.js"></script>
		<script src="../JS/updateXML.js"></script>
		<script src="../JS/saveXML.js"></script>
		<script src="../JS/getFromSessvar.js"></script>
		<script src="../JS/sessionvars.js"></script>
		
		<script>
			function checkCookie(value) {
				sessvars.value = value;
			}
		</script>
		
		<script>
			function getTabs() {
				var y = loadProject(sessvars.projectName);
				
				var name = y.documentElement.childNodes;
				var div = document.getElementById("head1");
												
				for(var i = 0; i < name.length; i++) {
					div.innerHTML += ("<button onclick=loadXSLT(0,0,'"+name[i].childNodes[0].nodeValue+"')>"+name[i].childNodes[0].nodeValue+"</button>");
				}
				sessvars.first = name[0].childNodes[0].nodeValue;
			}
		</script>
		
		<script>
			function loadXSLT(withTabs, withCurrent, xmlToLoad){
			//Load tabs from project file
			if(withTabs == 1){
				getTabs();
				xmlToLoad = sessvars.first;
			}
			
			//Load XML and XSL '0' = loadnew '1' = reload with current
			if(withCurrent == 0){
				sessvars.xml = xmlToLoad;
				xml = loadXML(sessvars.xml);
				var textVersion = xml.xml;
				var styleStringStart = textVersion.search("href=");
				var styleStringPart = textVersion.substring(styleStringStart);
				var styleStringEnd = styleStringPart.search(">");
				var styleName = styleStringPart.substring(6, styleStringEnd-2);
				sessvars.xsl = styleName;
				xsl = loadXML(sessvars.xsl);
			}
			
			if(withCurrent == 1){
				xml = loadXML(sessvars.xml);
				xsl = loadXML(sessvars.xsl);
			}
			
			//Transform XML to HTML
			var value = xml.transformNode(xsl);
			alert(value);
			
			//Search for script in generated HTML, this should be put into a loop in case of multiple scripts
			var scriptStart = value.search("<script>");
			var scriptEnd = value.search("<"+'/'+"script>");
			
			//Create substring that is the script, offset start because script tag is inserted with createElement method
			var xsltScript = value.substring(scriptStart+8, scriptEnd);
			var editScript = xsltScript.replace("edit = 0", "edit=1");
			alert(editScript);
			//Find the head so we know where to append
			var head = document.getElementsByTagName('head')[0];
			
			//Create our new script object
			var script = document.createElement('script');
			script.type = 'text/javascript';
			script.text = editScript;
			
			//Append it to the head
			head.appendChild(script);
			
			//Search for the style in generated HTML
			var styleStart = value.search('<style type="text'+'/'+'css">');
			var styleEnd = value.search("<"+'/'+"style>");
			//Create substring that is the style
			var xsltStyle = value.substring(styleStart+23, styleEnd);
			
			//Find Style insert location
			var styleSpot = head.getElementsByTagName('style')[0];
			var sheet = document.styleSheets[0];
			//Append new styling
			sheet.cssText += xsltStyle;
			
			//Append our generated HTML to the newly formatted page
			document.getElementById("xsltDiv").innerHTML = value;
			document.getElementById("xsltDiv").innerHTML += "<button onclick='saveXML(xml)'>Save</button>";
			}
		</script>
		
		
	</head>
	
	<body onload="loadXSLT(1,0)">
		<div id="wrapper">
		    <div id="head1">
		        <button onclick=location.href='rtm.hta'>Create Matrix</button>
		    </div>
			<div id="xsltDiv">
			    <h1>Preview</h1>
			</div>
		</div>
	</body>
</html>
